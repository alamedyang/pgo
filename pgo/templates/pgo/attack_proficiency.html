{% extends 'pgo/pgo_base.html' %}


{% block content %}
<div class="main-wrapper">
    <form id="attack-pro-form">
        {% csrf_token %}

        <span id="attacker_error" class="form-error"></span>
        <select id="attacker" class="attack-pro-select">
            <option value="-1" disabled selected>Select attacker</option>
            {% for data in pokemon_data %}
                <option value="{{ data.0 }}">{{ data.1 }}</option>
            {% endfor %}
        </select>
        <br>

        <span id="quick_move_error" class="form-error"></span>
        <select id="quick_move" class="attack-pro-select" disabled>
            <option value="-1" disabled selected>Quick move</option>
        </select>
        <br>

        <span id="cinematic_move_error" class="form-error"></span>
        <select id="cinematic_move" class="attack-pro-select" disabled>
            <option value="-1" disabled selected>Cinematic move</option>
        </select>
        <br>

        <span id="attacker_level_error" class="form-error"></span>
        <input type="number" id="attacker_level" class="attack-pro-input" name="attacker_level" placeholder="Attacker level" min="1" max="40" step="0.5">

        <span id="attack_iv_error" class="form-error"></span>
        <input type="number" id="attack_iv" class="attack-pro-input" name="attack_iv" placeholder="ATK IV" min="0" max="15" step="1">
        <br>

        <span id="defender_error" class="form-error"></span>
        <select id="defender" class="attack-pro-select">
            <option value="-1" disabled selected>Select defender</option>
            {% for data in pokemon_data %}
                <option value="{{ data.0 }}">{{ data.1 }}</option>
            {% endfor %}
        </select>
        <br>

        <span id="defender_level_error" class="form-error"></span>
        <input type="number" id="defender_level" class="attack-pro-input" name="defender_level" placeholder="Defender level" min="1" max="40" step="0.5" value="40">

        <span id="defense_iv_error" class="form-error"></span>
        <input type="number" id="defense_iv" class="attack-pro-input" name="defense_iv" placeholder="DEF IV" min="0" max="15" step="1" value="15">
        <br>

        <input type="submit" id="submit" name="submit" class="a-pro-button" disabled>
    </form>

    <div class="attack-proficiency-info">
        <p>
            <span id="summary"></span>
        </p>
        <p>
            <span id="attacker_quick_move"></span> does
            <span id="quick_attack_damage"></span> damage per hit
            (<span id="quick_attack_dps"></span> DPS)
        </p>
        <p>
            <span id="attacker_cinematic_move"></span> does
            <span id="cinematic_attack_damage"></span> damage per hit
            (<span id="cinematic_attack_dps"></span> DPS)
        </p>
    </div>

    <div class="attack-proficiency-stats-wrapper">
        <span>Click a cell for details</span>

        <p class="attack-proficiency-summary"></p>
        <table id="attack-proficiency-stats">
            <tbody></tbody>
        </table>
    </div>
</div>
{% endblock content %}

{% block scripts %}
    {{ block.super }}

    <script type="text/javascript">
        $(document).ready(function(){
            $('.attack-pro-select').select2()
            // maintain tab index order
            $('select').on('select2:close', function() {
                $(this).focus()
            })

            var quickMoveSelect = $('#quick_move')
            var cinematicMoveSelect = $('#cinematic_move')
            var defenderLevelInput = $('#defender_level')
            var defenseIVInput = $('#defense_iv')
            var submitButton = $('#submit')
            var formData = {
                defenderLevel: defenderLevelInput.val(),
                defenseIV: defenseIVInput.val(),
            }
            var tableBody = $('#attack-proficiency-stats').find('tbody')


            $('#attacker').change(function() {
                filterQueryset(this.value)
                formData.attacker = this.value
            })
            quickMoveSelect.change(function() {
                formData.quickMove = this.value
            })
            cinematicMoveSelect.change(function() {
                formData.cinematicMove = this.value
            })
            $('#attacker_level').on('change', function() {
                setValidLevel(this, 'attackerLevel')
            })
            $('#attack_iv').on('change keyup', function() {
                setValidIV(this, 'attackIV')
            })
            defenderLevelInput.on('change', function() {
                setValidLevel(this, 'defenderLevel')
            })
            defenseIVInput.on('change keyup', function() {
                setValidIV(this, 'defenseIV')
            })

            $('#defender').change(function() {
                formData.defender = this.value
            })

            $('#attack-pro-form').on('submit', function(event) {
                event.preventDefault()
                submitForm(formData)
            })

            var formInputs = $('.attack-pro-select, .attack-pro-input')
            formInputs.on('change keyup paste', function() {
                var disabled = true

                if (Object.keys(formData).length === formInputs.length) {
                    disabled = false
                    for (prop in formData) {
                        if (formData[prop] < 0) {
                            disabled = true
                        }
                    }
                }
                submitButton.prop('disabled', disabled)
            })

            tableBody.on('click', 'td.attack-proficiency-detail', function(e){
                e.preventDefault()
                tableBody.find('#detail-summary').remove()

                var level = tableBody.find('tr').eq(
                    $(e.currentTarget).parent().index()).find('td').eq(0)[0].textContent
                var defenseIV = tableBody.find('tr').eq(
                    0).find('td').eq($(e.currentTarget).index())[0].textContent

                var element = $(e.currentTarget)
                getAttackProficiencyDetail(level, defenseIV, formData, element.parent())
            })

            function setValidLevel(input, inputName) {
                var choice = validateLevel(input)

                if (!isNaN(choice)) {
                    input.value = choice
                    formData[inputName] = input.value
                }
                else {
                    formData[inputName] = "-1"
                }
            }

            function setValidIV(input, inputName) {
                var choice = validateIV(input)

                if (!isNaN(choice)) {
                    input.value = choice
                    formData[inputName] = input.value
                }
                else {
                    formData[inputName] = "-1"
                }
            }

            function filterQueryset(value){
                if (parseInt(value) > 0) {
                    $.ajax({
                        url: "{% url 'api-pgo:move-list' %}",
                        type: 'GET',
                        data: {
                            'pokemon-id': value
                        },
                        success: function(json){
                            clearMoveInputs()
                            $.each(json.results, function(i, move) {
                                if (move.category === 'QK') {
                                    quickMoveSelect.prop('disabled', false)
                                    quickMoveSelect.append(
                                        '<option value=' + move.id + '>' + move.name + '</option>'
                                    )
                                }
                                else {
                                    cinematicMoveSelect.prop('disabled', false)
                                    cinematicMoveSelect.append(
                                        '<option value=' + move.id + '>' + move.name + '</option>'
                                    )
                                }
                            })
                        },
                        error: function(xhr, errmsg, err){
                            console.log('filter error', xhr)
                        }
                    })
                }
                else {
                    quickMoveSelect.prop('disabled', true)
                    cinematicMoveSelect.prop('disabled', true)
                    clearMoveInputs()
                }
            }

            function submitForm(formData) {
                $.ajax({
                    url: "{% url 'api-pgo:attack-proficiency' %}",
                    type: 'POST',
                    data: {
                        'attacker': formData.attacker,
                        'quick_move': formData.quickMove,
                        'cinematic_move': formData.cinematicMove,
                        'attacker_level': formData.attackerLevel,
                        'attack_iv': formData.attackIV,
                        'defender': formData.defender,
                        'defender_level': formData.defenderLevel,
                        'defense_iv': formData.defenseIV,
                        'csrfmiddlewaretoken': '{{ csrf_token }}'
                    },
                    success: function(json){
                        displayAttackProficiency(json)
                        generateAttackProficiencyStats(json)
                    },
                    error: function(xhr, errmsg, err){
                        displayFieldErrors(xhr.responseJSON)
                    }
                })
            }

            function generateAttackProficiencyStats(json) {
                $.ajax({
                    url: "{% url 'api-pgo:attack-proficiency-stats' %}",
                    type: 'POST',
                    data: {
                        'attacker': JSON.stringify(json.attacker),
                        'quick_move': JSON.stringify(json.quick_move),
                        'cinematic_move': JSON.stringify(json.cinematic_move),
                        'defender': JSON.stringify(json.defender),
                        'csrfmiddlewaretoken': '{{ csrf_token }}'
                    },
                    success: function(json){
                        tableBody.empty()

                        for (var i = 0; i < json.length; i++) {
                            var tr = $('<tr>')
                            for (value in json[i]) {
                                tr.append($('<td>').append(value))

                                var td = $('<td>')
                                for (var j = 0; j < json[i][value].length; j++) {
                                    td.append(json[i][value][j])

                                    if (i > 0) {
                                        td.append($('<br>'))
                                    }
                                    if (j % 2 === 1) {
                                        var text = td[0].textContent
                                        if (text.length > 2) {
                                            td.addClass('attack-proficiency-detail')
                                        }
                                        if (text.indexOf('*') !== - 1) {
                                            td.addClass('significant-increase')
                                        }
                                        td[0].innerHTML = td[0].innerHTML.replace(/\*/g, '')
                                        tr.append(td)
                                        td = $('<td>')
                                    }
                                }
                            }
                            tableBody.append(tr)
                        }
                        $('.attack-proficiency-stats-wrapper').show()
                    },
                    error: function(xhr, errmsg, err){
                        console.log('stats error', xhr)
                    }
                })
            }

            function displayAttackProficiency(json) {
                $('.attack-proficiency-info').show()
                $('#summary').html(json.summary)

                $('#attacker_quick_move').html(json.quick_move.name)
                $('#quick_attack_damage').html(json.quick_move.damage_per_hit)
                $('#quick_attack_dps').html(json.quick_move.dps)

                $('#attacker_cinematic_move').html(json.cinematic_move.name)
                $('#cinematic_attack_damage').html(json.cinematic_move.damage_per_hit)
                $('#cinematic_attack_dps').html(json.cinematic_move.dps)

                $('.attacker_name').html(json.attacker.name)
                $('.defender_name').html(json.defender.name)
            }

            function getAttackProficiencyDetail(level, defenseIV, formData, rowToAppend) {
                $.ajax({
                    url: "{% url 'api-pgo:attack-proficiency-detail' %}",
                    type: 'POST',
                    data: {
                        'attacker': formData.attacker,
                        'quick_move': formData.quickMove,
                        'cinematic_move': formData.cinematicMove,
                        'attacker_level': formData.attackerLevel,
                        'attack_iv': formData.attackIV,
                        'defender': formData.defender,
                        'defender_level': level,
                        'defense_iv': defenseIV,
                        'csrfmiddlewaretoken': '{{ csrf_token }}'
                    },
                    success: function(json) {
                        var marginLength = rowToAppend.children().length * 4
                        var totalWidth = rowToAppend.outerWidth(true) - marginLength
                        var wrapper = $('<tr id="detail-summary"><td width="'
                            + totalWidth + '" colspan="7"></td></tr>').hide()
                        var summary = $('<p>' + json.summary + '</p>')
                        var wrapperTd = wrapper.find('td')
                        wrapperTd.append(summary)

                        var details = json.details
                        if (details.length > 1) {
                            wrapperTd.append($('<p>It could do better if it was powered up!</p>'))
                            var detailsTable = $('<table width="' + totalWidth + '"></table>')
                            detailsTable.append($('<tr id="detail-summary"><td width="10%">' +
                                details[0][0] + '</td><td width="30%">' + details[0][1] +
                                '</td><td width="30%">' + details[0][2] + '</td><td width="30%">'
                                + details[0][3] + '</td></tr>'))

                            for (row in details) {
                                if (row > 0) {
                                    detailsTable.append($(
                                        '<tr><td>' + details[row][0] +
                                        '</td><td>' + details[row][1] +
                                        '</td><td>' + details[row][2] +
                                        '</td><td>' + details[row][3] +
                                        '</td></tr>'
                                    ))
                                }
                            }
                            wrapperTd.append(detailsTable)
                        }
                        rowToAppend.after(wrapper)
                        wrapper.show('fast')
                    },
                    error: function(xhr, errmsg, err){
                        console.log('detail error', xhr)
                    }
                })
            }

            function displayFieldErrors(errorObject) {
                for (error in errorObject) {
                    var selector = '#' + error + '_error'
                    $(selector).html(errorObject[error])
                }
            }

            function clearMoveInputs() {
                quickMoveSelect.empty()
                quickMoveSelect.append(
                    '<option value="-1" disabled selected>Select quick move</option>'
                )
                cinematicMoveSelect.empty()
                cinematicMoveSelect.append(
                    '<option value="-1" disabled selected>Select cinematic move</option>'
                )
                formData['quickMove'] = -1
                formData['cinematicMove'] = -1
            }

            function validateLevel(input) {
                var level = parseFloat(input.value)

                if (level < 0) {
                    level *= - 1
                }
                if (level < 1) {
                    level = 1
                }
                if (level > 40) {
                    level = 40
                }
                if ((level * 10) % 5 !== 0) {
                    level = parseInt(level)
                }
                return level
            }

            function validateIV(input) {
                var attack = parseInt(input.value)

                if (attack < 0) {
                    attack = 0
                }
                if (attack > 15) {
                    attack = 15
                }
                return attack
            }
        })
    </script>

    <style type="text/css">
        .attack-pro-select {
            width: 200px;
        }
        .attack-pro-input {
            width: 92px;
            height: 20px;
        }
        .a-pro-button {
            width: 200px;
            height: 25px;
        }
        .form-error {
            color: red;
        }
        .attack-proficiency-info {
            display: none;
        }
        .attack-proficiency-stats-wrapper {
            display: none;
        }
        #attack-proficiency-stats td {
            text-align: center;
            border: 1px solid black;
            padding: 10px;
        }
        .attack-proficiency-detail {
            cursor: pointer;
        }
        .significant-increase {
            background-color: #01FFA9;
        }
    </style>
{% endblock scripts %}
